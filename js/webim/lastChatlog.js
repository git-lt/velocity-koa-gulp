var page={
	faces:{"[微笑]":"https://qncdn.qiakr.com/webim/face2/emo000.png","[撇嘴]":"https://qncdn.qiakr.com/webim/face2/emo001.png","[色]":"https://qncdn.qiakr.com/webim/face2/emo002.png","[发呆]":"https://qncdn.qiakr.com/webim/face2/emo003.png","[得意]":"https://qncdn.qiakr.com/webim/face2/emo004.png","[流泪]":"https://qncdn.qiakr.com/webim/face2/emo005.png","[害羞]":"https://qncdn.qiakr.com/webim/face2/emo006.png","[闭嘴]":"https://qncdn.qiakr.com/webim/face2/emo007.png","[睡]":"https://qncdn.qiakr.com/webim/face2/emo008.png","[大哭]":"https://qncdn.qiakr.com/webim/face2/emo009.png","[尴尬]":"https://qncdn.qiakr.com/webim/face2/emo010.png","[发怒]":"https://qncdn.qiakr.com/webim/face2/emo011.png","[调皮]":"https://qncdn.qiakr.com/webim/face2/emo012.png","[呲牙]":"https://qncdn.qiakr.com/webim/face2/emo013.png","[惊讶]":"https://qncdn.qiakr.com/webim/face2/emo014.png","[难过]":"https://qncdn.qiakr.com/webim/face2/emo015.png","[酷]":"https://qncdn.qiakr.com/webim/face2/emo016.png","[冷汗]":"https://qncdn.qiakr.com/webim/face2/emo017.png","[抓狂]":"https://qncdn.qiakr.com/webim/face2/emo018.png","[吐]":"https://qncdn.qiakr.com/webim/face2/emo019.png","[偷笑]":"https://qncdn.qiakr.com/webim/face2/emo020.png","[愉快]":"https://qncdn.qiakr.com/webim/face2/emo021.png","[白眼]":"https://qncdn.qiakr.com/webim/face2/emo022.png","[傲慢]":"https://qncdn.qiakr.com/webim/face2/emo023.png","[饥饿]":"https://qncdn.qiakr.com/webim/face2/emo024.png","[困]":"https://qncdn.qiakr.com/webim/face2/emo025.png","[惊恐]":"https://qncdn.qiakr.com/webim/face2/emo026.png","[流汗]":"https://qncdn.qiakr.com/webim/face2/emo027.png","[憨笑]":"https://qncdn.qiakr.com/webim/face2/emo028.png","[悠闲]":"https://qncdn.qiakr.com/webim/face2/emo029.png","[奋斗]":"https://qncdn.qiakr.com/webim/face2/emo030.png","[咒骂]":"https://qncdn.qiakr.com/webim/face2/emo031.png","[疑问]":"https://qncdn.qiakr.com/webim/face2/emo032.png","[嘘]":"https://qncdn.qiakr.com/webim/face2/emo033.png","[晕]":"https://qncdn.qiakr.com/webim/face2/emo034.png","[疯了]":"https://qncdn.qiakr.com/webim/face2/emo035.png","[衰]":"https://qncdn.qiakr.com/webim/face2/emo036.png","[骷髅]":"https://qncdn.qiakr.com/webim/face2/emo037.png","[敲打]":"https://qncdn.qiakr.com/webim/face2/emo038.png","[再见]":"https://qncdn.qiakr.com/webim/face2/emo039.png","[擦汗]":"https://qncdn.qiakr.com/webim/face2/emo040.png","[抠鼻]":"https://qncdn.qiakr.com/webim/face2/emo041.png","[鼓掌]":"https://qncdn.qiakr.com/webim/face2/emo042.png","[糗大了]":"https://qncdn.qiakr.com/webim/face2/emo043.png","[坏笑]":"https://qncdn.qiakr.com/webim/face2/emo044.png","[左哼哼]":"https://qncdn.qiakr.com/webim/face2/emo045.png","[右哼哼]":"https://qncdn.qiakr.com/webim/face2/emo046.png","[哈欠]":"https://qncdn.qiakr.com/webim/face2/emo047.png","[鄙视]":"https://qncdn.qiakr.com/webim/face2/emo048.png","[委屈]":"https://qncdn.qiakr.com/webim/face2/emo049.png","[快哭了]":"https://qncdn.qiakr.com/webim/face2/emo050.png","[阴险]":"https://qncdn.qiakr.com/webim/face2/emo051.png","[亲亲]":"https://qncdn.qiakr.com/webim/face2/emo052.png","[吓]":"https://qncdn.qiakr.com/webim/face2/emo053.png","[可怜]":"https://qncdn.qiakr.com/webim/face2/emo054.png","[菜刀]":"https://qncdn.qiakr.com/webim/face2/emo055.png","[西瓜]":"https://qncdn.qiakr.com/webim/face2/emo056.png","[啤酒]":"https://qncdn.qiakr.com/webim/face2/emo057.png","[篮球]":"https://qncdn.qiakr.com/webim/face2/emo058.png","[乒乓]":"https://qncdn.qiakr.com/webim/face2/emo059.png","[咖啡]":"https://qncdn.qiakr.com/webim/face2/emo060.png","[饭]":"https://qncdn.qiakr.com/webim/face2/emo061.png","[猪头]":"https://qncdn.qiakr.com/webim/face2/emo062.png","[玫瑰]":"https://qncdn.qiakr.com/webim/face2/emo063.png","[凋谢]":"https://qncdn.qiakr.com/webim/face2/emo064.png","[嘴唇]":"https://qncdn.qiakr.com/webim/face2/emo065.png","[爱心]":"https://qncdn.qiakr.com/webim/face2/emo066.png","[心碎]":"https://qncdn.qiakr.com/webim/face2/emo067.png","[蛋糕]":"https://qncdn.qiakr.com/webim/face2/emo068.png","[闪电]":"https://qncdn.qiakr.com/webim/face2/emo069.png","[炸弹]":"https://qncdn.qiakr.com/webim/face2/emo070.png","[刀]":"https://qncdn.qiakr.com/webim/face2/emo071.png","[足球]":"https://qncdn.qiakr.com/webim/face2/emo072.png","[瓢虫]":"https://qncdn.qiakr.com/webim/face2/emo073.png","[便便]":"https://qncdn.qiakr.com/webim/face2/emo074.png","[月亮]":"https://qncdn.qiakr.com/webim/face2/emo075.png","[太阳]":"https://qncdn.qiakr.com/webim/face2/emo076.png","[礼物]":"https://qncdn.qiakr.com/webim/face2/emo077.png","[拥抱]":"https://qncdn.qiakr.com/webim/face2/emo078.png","[强]":"https://qncdn.qiakr.com/webim/face2/emo079.png","[弱]":"https://qncdn.qiakr.com/webim/face2/emo080.png","[握手]":"https://qncdn.qiakr.com/webim/face2/emo081.png","[胜利]":"https://qncdn.qiakr.com/webim/face2/emo082.png","[抱拳]":"https://qncdn.qiakr.com/webim/face2/emo083.png","[勾引]":"https://qncdn.qiakr.com/webim/face2/emo084.png","[拳头]":"https://qncdn.qiakr.com/webim/face2/emo085.png","[差劲]":"https://qncdn.qiakr.com/webim/face2/emo086.png","[爱你]":"https://qncdn.qiakr.com/webim/face2/emo087.png","[NO]":"https://qncdn.qiakr.com/webim/face2/emo088.png","[OK]":"https://qncdn.qiakr.com/webim/face2/emo089.png","[爱情]":"https://qncdn.qiakr.com/webim/face2/emo090.png","[飞吻]":"https://qncdn.qiakr.com/webim/face2/emo091.png","[跳跳]":"https://qncdn.qiakr.com/webim/face2/emo092.png","[发抖]":"https://qncdn.qiakr.com/webim/face2/emo093.png","[怄火]":"https://qncdn.qiakr.com/webim/face2/emo094.png","[转圈]":"https://qncdn.qiakr.com/webim/face2/emo095.png","[磕头]":"https://qncdn.qiakr.com/webim/face2/emo096.png","[回头]":"https://qncdn.qiakr.com/webim/face2/emo097.png","[跳绳]":"https://qncdn.qiakr.com/webim/face2/emo098.png","[投降]":"https://qncdn.qiakr.com/webim/face2/emo099.png"},
	init:function(){
		this.getLogList();
    Base.hideOptionMenu();
	},
	messageFormat:function(message){
	    var content,msg;
	    try{
	    	msg = JSON.parse(message);
	    }catch(e){
	        msg=message;
	    }
	    if(typeof msg.content == "object"){
	      content = JSON.stringify(msg.content);
	    }else{
	      if(msg.type===0){
	        content = msg.content.replaceFace().replaceTextUrl();
	      }else{
	        content = msg.content;
	      }
	    }
	    return content;
	  },
	getLogList:function(){
		var param={
	    from : getUrlParam("from"),
			toId : getUrlParam("to"),
			fromRole:3,
			toRole:2,
			before : getUrlParam("before"),
			token : getUrlParam("token")
		};
		$.getJSON("../getCustomerChatLogWithLastSales.json",param,function(data){
			if(data.status=="0"){
				var list = data.result.chatlogList,listStr = "";
	            if(list.length === 0){
	                listStr = '<div class="noResult"><span>之前没有聊天记录哦</span></div>';
	            }else{
	            	$.each(list,function(i,e){
	                  if(JSON.parse(e.content).type !== null){
	                    listStr += template("tempData",{
	                      text: page.messageFormat(e.content),
	                      msgType:JSON.parse(e.content).type,
	                      name: e.from == $("#salesId").val() ? $("#salesName").val() : $("#customerName").val(),
	                      avatar: e.from == $("#salesId").val() ? $("#salesAvatar").val() : $("#customerAvatar").val(),
	                      time: new Date(e.sendTime).format("MM-dd HH:mm")
	                    });
	                  }
	              });
	            }
				$("#listContainer").append(listStr);
			}
		});
	}
};

// 模板渲染扩展函数
template.config('escape', false);
template.helper('getJsonParam', function (date, format) {
    var json = JSON.parse(date);
    return json[format];
});
template.helper('getStockUrl', function (date) {
    return "../mall/getStockInfoForCustomer.htm?salesId="+getUrlParam("salesId")+"&"+date.match(/stockId=\d*/);
});
template.helper('renameAudio', function (date) {
    return date.replace(/.amr/gi,"cdf2d.mp3");
});
template.helper('audioTime', function (date) {
    var json = JSON.parse(date);
    return Math.round(json.meta.duration/1000);
});
template.helper('audioLength', function (date) {
    var json = JSON.parse(date);
    return Math.round(json.meta.duration/1000)*20;
});
template.helper('getSharePhotoUrl', function (date) {
    var json = JSON.parse(date);
    return json.photoUrl.url;
});

Date.prototype.format = function(fmt) { //author: meizz
  var o = {
    "Y+" : this.getFullYear(),
    "M+" : this.getMonth()+1,                 //月份
    "d+" : this.getDate(),                    //日
    "H+" : this.getHours(),                   //小时
    "m+" : this.getMinutes(),                 //分
    "s+" : this.getSeconds(),                 //秒
    "q+" : Math.floor((this.getMonth()+3)/3), //季度
    "S"  : this.getMilliseconds()             //毫秒
  };
  if(/(y+)/.test(fmt)) {
      fmt=fmt.replace(RegExp.$1, (this.getFullYear()+"").substr(4 - RegExp.$1.length));
  }
  for(var k in o) {
    if(new RegExp("("+ k +")").test(fmt)){
        fmt = fmt.replace(RegExp.$1, (RegExp.$1.length==1) ? (o[k]) : (("00"+ o[k]).substr((""+ o[k]).length)));
    }
  }
  return fmt;
};

String.prototype.replaceFace = function(){
    var p = /\[[^\]]+\]/g;
    var result= this.match(p);
    var s = this;
    for(var i in result) {
        var face = result[i];
        if(!page.faces[face]) {
            continue;
        }
        s = s.replace(face, '<img class="face" src="' + page.faces[face] + '" />');
    }
    return s.toString();
};

String.prototype.replaceTextUrl = function(){
  var s = this;
  var Expression='((https://)|(http://)|(www\\.)){1}[A-Za-z0-9-_:\/]+\\.[A-Za-z0-9-_:#%&\?\/.=]+';
  var objExp=new RegExp(Expression,"g");
  if(objExp.test(s)){
    var r = s.match(objExp);
    var newStr=s;
    for(var i=0;i<r.length;i++){
        if(r[i].indexOf("webim/face")<0){
            newStr = newStr.replace(r[i],'<a href="'+((r[i].indexOf("https://")<0 && r[i].indexOf("http://")<0)  ? "http://"+r[i] : r[i])+'">'+r[i]+'</a>');
        }
    }
    return newStr.toString();
  }else{
    return s.toString();
  }
};

page.init();